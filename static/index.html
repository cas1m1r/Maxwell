<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Maxwell Observatory</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
      background: #111;
      color: #eee;
    }
    #graph {
      flex: 2;
      border-right: 1px solid #333;
      position: relative;
    }
    #sidebar {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #181818;
    }
    #sidebar h2, #sidebar h3 {
      margin-top: 0;
    }
    .info-block {
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #202020;
    }
    .chip {
      display: inline-block;
      padding: 2px 6px;
      margin: 2px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #333;
    }
    #capsules-list {
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    #capsules-list div {
      cursor: pointer;
      padding: 4px 6px;
    }
    #capsules-list div:hover {
      background: #272727;
    }
    #top-bar {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: #ccc;
      z-index: 10;
    }
    #top-bar button {
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
      cursor: pointer;
    }
    #top-bar button:hover {
      background: #333;
    }
    #run-select {
      background: #222;
      color: #eee;
      border-radius: 4px;
      border: 1px solid #555;
      padding: 2px 6px;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div id="graph">
    <div id="top-bar">
      <div>
        Maxwell Observatory –
        <select id="run-select"></select>
      </div>
      <div>
        <button id="refresh-btn">Refresh Graph</button>
        <label style="margin-left:8px;">
          <input type="checkbox" id="auto-refresh" /> Auto-refresh (5s)
        </label>
      </div>
    </div>
    <svg id="graph-svg" width="100%" height="100%"></svg>
  </div>
  <div id="sidebar">
    <h2>Node Details</h2>
    <div class="info-block" id="node-info">
      <em>Click a node in the graph to inspect it.</em>
    </div>

    <h3>Capsules</h3>
    <div class="info-block" id="capsules-list">
      <em>Loading capsules…</em>
    </div>

    <h3>Capsule Summary</h3>
    <div class="info-block" id="capsule-summary">
      <em>Click a capsule node or capsule entry above.</em>
    </div>
  </div>

  <!-- D3.js from CDN -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    const svg = d3.select("#graph-svg");
    const width = window.innerWidth * 2 / 3;
    const height = window.innerHeight;

    // All graph elements live in this group; zoom transforms it.
    const container = svg.append("g").attr("id", "graph-layer");

    const zoom = d3.zoom()
      .scaleExtent([0.05, 5])
      .on("zoom", (event) => {
        container.attr("transform", event.transform);
      });

    svg.call(zoom).on("dblclick.zoom", null);

    let simulation = null;
    let currentGraph = null;
    let currentRun = "__all__";
    let autoTimer = null;

    function nodeColor(d) {
      if (d.type === "capsule") return "#f5a623";   // orange
      if (d.type === "concept") return "#4a90e2";   // blue
      if (d.type === "issue")   return "#e94e77";   // pink/red
      return "#888";
    }

    function nodeRadius(d) {
      if (d.type === "capsule") return 12;
      if (d.type === "concept") return 6 + Math.min(10, d.degree || 0);
      if (d.type === "issue")   return 8;
      return 5;
    }

    function renderGraph(graph) {
      currentGraph = graph;
      container.selectAll("*").remove();

      const link = container.append("g")
        .attr("stroke", "#444")
        .attr("stroke-opacity", 0.6)
        .selectAll("line")
        .data(graph.edges)
        .enter()
        .append("line")
        .attr("stroke-width", e => e.type === "capsule_concept" ? 0.5 : 1.0);

      const node = container.append("g")
        .attr("stroke", "#111")
        .attr("stroke-width", 1)
        .selectAll("circle")
        .data(graph.nodes)
        .enter()
        .append("circle")
        .attr("r", nodeRadius)
        .attr("fill", nodeColor)
        .call(drag())
        .on("click", (event, d) => {
          showNodeDetails(d);
          if (d.type === "capsule") {
            const cid = d.id.replace(/^capsule:/, "");
            loadCapsule(cid);
          }
        });

      const label = container.append("g")
        .selectAll("text")
        .data(graph.nodes)
        .enter()
        .append("text")
        .attr("font-size", "10px")
        .attr("fill", "#ccc")
        .text(d => d.type === "capsule" ? d.label : "")
        .attr("pointer-events", "none");

      simulation = d3.forceSimulation(graph.nodes)
        .force("link", d3.forceLink(graph.edges).id(d => d.id).distance(e => {
          if (e.type === "capsule_concept") return 60;
          if (e.type === "concept_issue")   return 80;
          return 40;
        }))
        .force("charge", d3.forceManyBody().strength(-120))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", () => {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          label
            .attr("x", d => d.x + 8)
            .attr("y", d => d.y + 4);
        });
    }

    function drag() {
      function dragstarted(event, d) {
        if (!event.active && simulation) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      function dragended(event, d) {
        if (!event.active && simulation) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
      return d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
    }

    function showNodeDetails(node) {
      const div = document.getElementById("node-info");
      const capsules = (node.capsules || []).join(", ");
      div.innerHTML = `
        <div><strong>Label:</strong> ${node.label}</div>
        <div><strong>ID:</strong> ${node.id}</div>
        <div><strong>Type:</strong> ${node.type}</div>
        <div><strong>Degree:</strong> ${node.degree || 0}</div>
        <div><strong>Capsules:</strong> ${capsules || "<em>none</em>"}</div>
      `;
    }

    async function loadGraph() {
      const res = await fetch(`/api/graph?run=${encodeURIComponent(currentRun)}`);
      const graph = await res.json();
      renderGraph(graph);
    }

    async function loadCapsulesList() {
      const res = await fetch(`/api/capsules?run=${encodeURIComponent(currentRun)}`);
      const data = await res.json();
      const listDiv = document.getElementById("capsules-list");
      if (!data.length) {
        listDiv.innerHTML = "<em>No capsules found for this run.</em>";
        return;
      }
      listDiv.innerHTML = "";
      data.forEach(c => {
        const row = document.createElement("div");
        row.textContent = `${c.id} – ${c.seed || "(no seed)"}`;
        row.onclick = () => loadCapsule(c.id);
        listDiv.appendChild(row);
      });
    }

    async function loadCapsule(cid) {
      const res = await fetch(`/api/capsule/${encodeURIComponent(cid)}?run=${encodeURIComponent(currentRun)}`);
      if (!res.ok) return;
      const cap = await res.json();
      const div = document.getElementById("capsule-summary");

      const numConcepts = Object.keys(cap.concepts || {}).length;
      const numIssues = Object.keys(cap.issues || {}).length;
      const numEdges = (cap.edges || []).length;
      const numQuestions = (cap.questions || []).length;

      div.innerHTML = `
        <div><strong>Seed:</strong> ${cap.seed || ""}</div>
        <div><strong>Concepts:</strong> ${numConcepts}</div>
        <div><strong>Issues:</strong> ${numIssues}</div>
        <div><strong>Edges:</strong> ${numEdges}</div>
        <div><strong>Questions:</strong> ${numQuestions}</div>
        <div style="margin-top:0.5rem;"><strong>Questions Explored:</strong></div>
        <div>${(cap.questions || []).slice(0, 10).map(q => `<div class="chip">${q}</div>`).join("")}</div>
      `;
    }

    async function loadRuns() {
      const res = await fetch("/api/runs");
      const runs = await res.json();
      const sel = document.getElementById("run-select");
      sel.innerHTML = "";

      if (!runs.length) {
        const opt = document.createElement("option");
        opt.value = "__all__";
        opt.textContent = "No runs found";
        sel.appendChild(opt);
        currentRun = "__all__";
        return;
      }

      runs.forEach((r, idx) => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label || r.id;
        sel.appendChild(opt);
        if (idx === 0) {
          currentRun = r.id;
        }
      });

      sel.onchange = () => {
        currentRun = sel.value;
        loadGraph();
        loadCapsulesList();
      };
    }

    document.getElementById("refresh-btn").onclick = () => {
      loadGraph();
      loadCapsulesList();
    };

    document.getElementById("auto-refresh").addEventListener("change", (e) => {
      if (e.target.checked) {
        autoTimer = setInterval(() => {
          loadGraph();
          loadCapsulesList();
        }, 5000);
      } else if (autoTimer) {
        clearInterval(autoTimer);
        autoTimer = null;
      }
    });

    (async () => {
      await loadRuns();
      await loadGraph();
      await loadCapsulesList();
    })();
  </script>
</body>
</html>
